<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision-Based Prosthetic Hand Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Using a specific, stable version of the library -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 16 / 9;
            margin: auto;
        }
        #webcam, #output_canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
            transform: scaleX(-1); /* Mirror the webcam feed */
        }
        .hand-icon-open, .hand-icon-closed {
            transition: opacity 0.3s ease-in-out;
        }
        #start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">Nikash Kumar and Sophia Tran's Prosthetic Hand Controller</h1>
        <p class="text-gray-400 mb-6">Show your hand to the camera. The prosthetic will mirror your fist's state.</p>

        <div id="controls" class="my-8">
            <div id="loading-indicator" class="flex items-center justify-center space-x-2 mb-4">
                <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-text" class="text-left">Initializing...</span>
            </div>
            <button id="start-button" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all">
                Start Camera
            </button>
        </div>

        <div class="video-container hidden mb-6 shadow-2xl bg-gray-800 rounded-xl">
            <video id="webcam" autoplay playsinline></video>
            <canvas id="output_canvas"></canvas>
        </div>

        <div id="status-display" class="hidden w-full max-w-md mx-auto bg-gray-800 rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">CAMERA STATUS</p>
                    <p id="detection-status" class="text-xl font-semibold text-yellow-400">Searching for hand...</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-sm">PROSTHETIC STATE</p>
                    <p id="fist-status" class="text-xl font-semibold text-cyan-400">--</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 flex justify-center items-center h-24">
                <!-- Open Hand Icon -->
                <svg id="hand-open" class="hand-icon-open h-20 w-20 text-green-400 opacity-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                    <path d="M236,112a8,8,0,0,1-16,0V88a8,8,0,0,0-8-8H200a8,8,0,0,1,0-16h12a24,24,0,0,1,24,24Zm-68-40a8,8,0,0,0-8,8v88a8,8,0,0,0,16,0V80a8,8,0,0,0-8-8Zm-48,0a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V80a8,8,0,0,0-8-8Zm-48,0a8,8,0,0,0-8,8v72a8,8,0,0,0,16,0V80a8,8,0,0,0-8-8Zm-40,24a8,8,0,0,0-8,8v40a8,8,0,0,0,16,0V104a8,8,0,0,0-8-8Zm16,128H88a32,32,0,0,1,0-64h24v-8a8,8,0,0,1,16,0v40h8a8,8,0,0,1,0,16h-8v16Z"/>
                </svg>
                <!-- Closed Hand Icon -->
                 <svg id="hand-closed" class="hand-icon-closed h-20 w-20 text-red-400 opacity-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor">
                    <path d="M208,88H152a8,8,0,0,0,0,16h56a8,8,0,0,1,0,16H152a8,8,0,0,0,0,16h56a8,8,0,0,1,0,16H152a8,8,0,0,0,0,16h56a8,8,0,0,1,0,16H152a8,8,0,0,0,0,16h56a24,24,0,0,0,24-24V112A24,24,0,0,0,208,88ZM96,88a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V96A8,8,0,0,0,96,88Zm-40,0a8,8,0,0,0-8,8v80a8,8,0,0,0,16,0V96A8,8,0,0,0,56,88Z"/>
                </svg>
            </div>
        </div>
    </div>

    <script type="module">
        // Import necessary modules from MediaPipe
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // Get DOM elements
        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        const loadingSpinner = document.getElementById("loading-spinner");
        const loadingText = document.getElementById("loading-text");
        const startButton = document.getElementById("start-button");
        const controlsDiv = document.getElementById("controls");
        const videoContainer = document.querySelector(".video-container");
        const statusDisplay = document.getElementById("status-display");
        const detectionStatusEl = document.getElementById("detection-status");
        const fistStatusEl = document.getElementById("fist-status");
        const handOpenIcon = document.getElementById("hand-open");
        const handClosedIcon = document.getElementById("hand-closed");

        let handLandmarker = undefined;
        let runningMode = "VIDEO";
        let webcamRunning = false;

        // Main function to initialize the HandLandmarker
        const createHandLandmarker = async () => {
             const loadingTimeout = setTimeout(() => {
                 loadingText.innerHTML = `<strong>Loading is taking a while...</strong><br>Check your internet connection or look for errors in the browser console (Press F12).`;
            }, 15000);

            try {
                loadingText.textContent = "1/3: Initializing Vision Tasks...";
                console.log("Step 1/3: Initializing Vision Tasks...");
                const vision = await FilesetResolver.forVisionTasks(
                    // Using the wasm files from the same stable version
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                
                loadingText.textContent = "2/3: Loading Hand Landmarker model...";
                console.log("Step 2/3: Loading Hand Landmarker model...");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        // Using the model path that corresponds to the stable version
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                        delegate: "CPU" 
                    },
                    runningMode: runningMode,
                    numHands: 1
                });
                
                clearTimeout(loadingTimeout);
                loadingText.textContent = "3/3: Model Loaded!";
                console.log("Step 3/3: Model Loaded Successfully!");
                loadingSpinner.classList.add("hidden");
                startButton.disabled = false;

            } catch (error) {
                clearTimeout(loadingTimeout);
                console.error("Error during model loading:", error);
                loadingSpinner.classList.add("hidden");
                loadingText.innerHTML = `<strong>Error loading model.</strong><br>Please check the console (Press F12) for details and ensure you're connected to the internet.`;
            }
        };
        createHandLandmarker();

        // Add event listener to the start button
        startButton.addEventListener("click", enableCam);

        // Function to enable the webcam feed
        function enableCam() {
            if (!handLandmarker) {
                console.log("Wait! HandLandmarker not loaded yet.");
                return;
            }
            controlsDiv.classList.add("hidden");
            videoContainer.classList.remove("hidden");
            statusDisplay.classList.remove("hidden");

            // Get user media
            navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            }).catch((err) => {
                console.error("Error accessing webcam: ", err);
                statusDisplay.innerHTML = `<p class="text-red-400">Error: Camera access denied. Please refresh and grant permission.</p>`;
                statusDisplay.classList.remove("hidden");
                videoContainer.classList.add("hidden");
            });
        };

        let lastVideoTime = -1;
        
        // The main prediction loop
        async function predictWebcam() {
            if (video.srcObject) {
                webcamRunning = true;
            }
            if (!webcamRunning) return;

            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;

            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, startTimeMs);
                
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                
                if (results.landmarks && results.landmarks.length > 0) {
                    detectionStatusEl.textContent = "Hand Detected";
                    detectionStatusEl.classList.remove("text-yellow-400");
                    detectionStatusEl.classList.add("text-green-400");
                    
                    for (const landmarks of results.landmarks) {
                        drawConnectors(canvasCtx, landmarks, HandLandmarker.HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 5 });
                        drawLandmarks(canvasCtx, landmarks, { color: "#FF0000", lineWidth: 2 });
                    }
                    
                    checkFistClosed(results.landmarks[0]);
                } else {
                    detectionStatusEl.textContent = "Searching for hand...";
                    detectionStatusEl.classList.remove("text-green-400");
                    detectionStatusEl.classList.add("text-yellow-400");
                    fistStatusEl.textContent = "--";
                    handOpenIcon.style.opacity = '0';
                    handClosedIcon.style.opacity = '0';
                }
                canvasCtx.restore();
            }
            window.requestAnimationFrame(predictWebcam);
        }
        
        function checkFistClosed(landmarks) {
            const indexFingerTip = landmarks[8];
            const indexFingerMcp = landmarks[5];
            const middleFingerTip = landmarks[12];
            const middleFingerMcp = landmarks[9];
            const ringFingerTip = landmarks[16];
            const ringFingerMcp = landmarks[13];
            
            if (indexFingerTip.y > indexFingerMcp.y && middleFingerTip.y > middleFingerMcp.y && ringFingerTip.y > ringFingerMcp.y) {
                fistStatusEl.textContent = "CLOSED";
                fistStatusEl.classList.remove("text-cyan-400");
                fistStatusEl.classList.add("text-red-400");
                handOpenIcon.style.opacity = '0';
                handClosedIcon.style.opacity = '1';
            } else {
                fistStatusEl.textContent = "OPEN";
                fistStatusEl.classList.remove("text-red-400");
                fistStatusEl.classList.add("text-cyan-400");
                handOpenIcon.style.opacity = '1';
                handClosedIcon.style.opacity = '0';
            }
        }

        function drawConnectors(ctx, landmarks, connections, style) {
            ctx.strokeStyle = style.color;
            ctx.lineWidth = style.lineWidth;
            for (const connection of connections) {
                const start = landmarks[connection.start];
                const end = landmarks[connection.end];
                ctx.beginPath();
                ctx.moveTo(start.x * ctx.canvas.width, start.y * ctx.canvas.height);
                ctx.lineTo(end.x * ctx.canvas.width, end.y * ctx.canvas.height);
                ctx.stroke();
            }
        }

        function drawLandmarks(ctx, landmarks, style) {
            ctx.fillStyle = style.color;
            for (const landmark of landmarks) {
                ctx.beginPath();
                ctx.arc(landmark.x * ctx.canvas.width, landmark.y * ctx.canvas.height, style.lineWidth * 2, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
    </script>
</body>
</html>
